<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HOMOS Chat</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#0f0f0f;color:#fff;}
.page{padding:15px;padding-bottom:90px}
.hidden{display:none}
h2,h3{text-align:center;margin:10px 0;}
input,button{width:100%;padding:14px;margin:8px 0;border-radius:12px;border:none;font-size:16px;}
input{background:#222;color:#fff}
button{background:#00ff88;font-weight:bold;cursor:pointer;}
button:active{opacity:.8}
.friend,.msg{background:#1e1e1e;padding:12px;margin:6px 0;border-radius:12px;}
.me{background:#00ff88;color:#000}
.online{color:#00ff88;font-size:13px}
.offline{color:#aaa;font-size:13px}
.nav{position:fixed;bottom:0;width:100%;height:70px;background:#000;display:flex;border-top:1px solid #222;}
.nav div{flex:1;text-align:center;padding-top:10px;font-size:14px;color:#aaa}
.nav div.active{color:#00ff88}
.nav div span{display:block;font-size:22px}
.error{color:#ff5555;text-align:center;margin-top:10px;font-size:14px;}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="page">
  <h2>ğŸ” HOMOS Chat</h2>
  <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù…">
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
  <button style="background:none;color:#00ff88" onclick="resetPassword()">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
  <div id="authError" class="error"></div>
</div>

<!-- HOME -->
<div id="home" class="page hidden">
  <h3>ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
  <input id="friendEmail" placeholder="Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <button onclick="addFriend()">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
  <div id="friends"></div>
</div>

<!-- PUBLIC CHAT -->
<div id="public" class="page hidden">
  <h3>ğŸŒ HOMOS Chat</h3>
  <div id="publicMsgs"></div>
  <input id="publicInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©">
  <button onclick="sendPublic()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PRIVATE CHAT -->
<div id="chat" class="page hidden">
  <h3 id="chatTitle"></h3>
  <div id="messages"></div>
  <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
  <button onclick="sendPrivate()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PROFILE -->
<div id="profile" class="page hidden">
  <h3>ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h3>
  <p id="info"></p>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- NAV -->
<div class="nav">
  <div onclick="nav('home')"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
  <div onclick="nav('public')"><span>ğŸŒ</span>Ø§Ù„Ø¹Ø§Ù…</div>
  <div onclick="nav('profile')"><span>ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</div>
</div>

<audio id="sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase config
firebase.initializeApp({
 apiKey:"AIzaSyBEazcwOjQFvTTvKP7C-LltEOnIlkF54x0",
 authDomain:"chat-ab546.firebaseapp.com",
 databaseURL:"https://chat-ab546-default-rtdb.firebaseio.com",
 projectId:"chat-ab546"
});

const auth=firebase.auth();
const db=firebase.database();
const ADMIN="ahmedfouad01278837444@gmail.com";
const BAN=3*60*60*1000;
let currentChat=null;

// REGISTER
function register(){
 const n=document.getElementById("name").value.trim();
 const e=document.getElementById("email").value.trim();
 const p=document.getElementById("pass").value.trim();
 if(!n||!e||!p){authError.innerText="âš ï¸ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";return;}
 auth.createUserWithEmailAndPassword(e,p)
 .then(res=>db.ref("users/"+res.user.uid).set({name:n,email:e,lastSeen:Date.now()}))
 .then(()=>authError.innerText="")
 .catch(err=>authError.innerText=err.message);
}

// LOGIN
function login(){auth.signInWithEmailAndPassword(email.value,pass.value).catch(err=>authError.innerText=err.message);}

// RESET PASSWORD
function resetPassword(){
 const e=document.getElementById("email").value.trim();
 if(!e){authError.innerText="âœ‰ï¸ Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ù‹Ø§";return;}
 auth.sendPasswordResetEmail(e)
 .then(()=>authError.innerText="âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„")
 .catch(err=>authError.innerText=err.message);
}

// LOGOUT
function logout(){auth.signOut();}

// STATE
auth.onAuthStateChanged(u=>{
 if(!u){showAuth();return;}
 show("home");
 info.innerText=u.email;
 db.ref("online/"+u.uid).set(true);
 db.ref("online/"+u.uid).onDisconnect().remove();
 db.ref("users/"+u.uid+"/lastSeen").onDisconnect().set(Date.now());
 loadFriends();
 loadPublic();
});

// FRIENDS
function addFriend(){
 const fe=document.getElementById("friendEmail").value.trim();
 if(!fe)return;
 db.ref("users").orderByChild("email").equalTo(fe).once("value",s=>{
  s.forEach(u=>{
   db.ref("friends/"+auth.currentUser.uid+"/"+u.key).set(true);
   db.ref("friends/"+u.key+"/"+auth.currentUser.uid).set(true);
  });
 });
 document.getElementById("friendEmail").value="";
}
function loadFriends(){
 friends.innerHTML="";
 db.ref("friends/"+auth.currentUser.uid).on("child_added",s=>{
  const uid=s.key;
  db.ref("users/"+uid).once("value",u=>{
   db.ref("online/"+uid).once("value",o=>{
    const d=document.createElement("div");
    d.className="friend";
    d.innerHTML=`<b>${u.val().name}</b><br>${o.exists()?'<span class="online">ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>':'<span class="offline">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± '+new Date(u.val().lastSeen).toLocaleTimeString()+'</span>'}`;
    d.onclick=()=>openPrivate(uid,u.val().name);
    friends.appendChild(d);
   });
  });
 });
}

// PRIVATE CHAT
function openPrivate(uid,name){
 currentChat=[auth.currentUser.uid,uid].sort().join("_");
 chatTitle.innerText=name;
 show("chat");
 messages.innerHTML="";
 db.ref("private/"+currentChat).off();
 db.ref("private/"+currentChat).on("child_added",s=>{
  const d=s.val();
  const m=document.createElement("div");
  m.className="msg "+(d.uid===auth.currentUser.uid?"me":"");
  m.innerText=d.text;
  messages.appendChild(m);
  if(d.uid!==auth.currentUser.uid) sound.play();
 });
}
function sendPrivate(){
 if(!msg.value)return;
 checkBan(()=>{db.ref("private/"+currentChat).push({uid:auth.currentUser.uid,text:msg.value,time:Date.now()}); msg.value="";});
}

// PUBLIC CHAT
function loadPublic(){
 publicMsgs.innerHTML="";
 db.ref("public").limitToLast(50).on("child_added",s=>{
  const d=s.val();
  const m=document.createElement("div");
  m.className="msg";
  m.innerHTML=`<b>${d.name}</b>: ${d.text}`;
  publicMsgs.appendChild(m);
  if(d.uid!==auth.currentUser.uid) sound.play();
 });
}
function sendPublic(){
 if(!publicInput.value)return;
 checkBan(()=>{db.ref("users/"+auth.currentUser.uid).once("value",u=>{
  db.ref("public").push({uid:auth.currentUser.uid,name:u.val().name,text:publicInput.value,time:Date.now()});
  publicInput.value="";
 });});
}

// BAN
function checkBan(cb){
 db.ref("bans/"+auth.currentUser.uid).once("value",s=>{
  if(s.exists() && Date.now()-s.val()<BAN){alert("ğŸš« Ù…Ø­Ø¸ÙˆØ± Ù…Ø¤Ù‚ØªÙ‹Ø§");}
  else{db.ref("bans/"+auth.currentUser.uid).remove(); cb();}
 });
}

// UI
function nav(p){show(p)}
function show(p){
 auth.classList.add("hidden");
 home.classList.add("hidden");
 public.classList.add("hidden");
 chat.classList.add("hidden");
 profile.classList.add("hidden");
 document.getElementById(p).classList.remove("hidden");
}
function showAuth(){auth.classList.remove("hidden");home.classList.add("hidden");public.classList.add("hidden");chat.classList.add("hidden");profile.classList.add("hidden");}
</script>

</body>
</html>
