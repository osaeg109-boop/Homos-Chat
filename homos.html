<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>HOMOS Chat</title>

<style>
body{margin:0;font-family:Arial;background:#0f0f0f;color:#fff}
.hidden{display:none}
.page{padding:15px;padding-bottom:80px}
input,button{width:100%;padding:12px;margin:5px 0;border-radius:8px;border:none}
button{background:#00ff88;font-weight:bold;cursor:pointer}
.friend,.msg{background:#222;padding:10px;margin:6px 0;border-radius:8px}
.me{background:#00ff88;color:#000}
.online{color:#00ff88;font-size:12px}
.offline{color:#aaa;font-size:12px}
.admin{color:red;font-size:12px;cursor:pointer}
.nav{position:fixed;bottom:0;width:100%;display:flex;background:#000}
.nav div{flex:1;text-align:center;padding:10px;color:#aaa}
.nav .active{color:#00ff88}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="page">
<h2>ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h2>
<input id="name" placeholder="Ø§Ù„Ø§Ø³Ù…">
<input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- HOME -->
<div id="home" class="page hidden">
<h2>ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
<input id="friendEmail" placeholder="Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯">
<button onclick="addFriend()">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
<div id="friends"></div>
</div>

<!-- PUBLIC CHAT -->
<div id="public" class="page hidden">
<h2>ğŸŒ HOMOS Chat</h2>
<div id="publicMsgs"></div>
<input id="publicInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©">
<button onclick="sendPublic()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PRIVATE CHAT -->
<div id="chat" class="page hidden">
<h3 id="chatTitle"></h3>
<div id="messages"></div>
<input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
<button onclick="sendPrivate()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PROFILE -->
<div id="profile" class="page hidden">
<h2>ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
<p id="info"></p>
<button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- NAV -->
<div class="nav">
<div onclick="nav('home')">ğŸ </div>
<div onclick="nav('public')">ğŸŒ</div>
<div onclick="nav('profile')">ğŸ‘¤</div>
</div>

<audio id="sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBEazcwOjQFvTTvKP7C-LltEOnIlkF54x0",
 authDomain:"chat-ab546.firebaseapp.com",
 databaseURL:"https://chat-ab546-default-rtdb.firebaseio.com",
 projectId:"chat-ab546"
});

const auth=firebase.auth();
const db=firebase.database();
const ADMIN="ahmedfouad01278837444@gmail.com";
const BAN=3*60*60*1000;
let currentChat=null;

// AUTH
function register(){
 auth.createUserWithEmailAndPassword(email.value,pass.value).then(u=>{
  db.ref("users/"+u.user.uid).set({
   name:name.value,email:email.value,lastSeen:Date.now()
  });
 });
}
function login(){auth.signInWithEmailAndPassword(email.value,pass.value);}
function logout(){auth.signOut();}

// STATE
auth.onAuthStateChanged(u=>{
 if(!u){showAuth();return;}
 show("home");
 db.ref("online/"+u.uid).set(true);
 db.ref("online/"+u.uid).onDisconnect().remove();
 db.ref("users/"+u.uid+"/lastSeen").onDisconnect().set(Date.now());
 loadFriends();
 loadPublic();
});

// FRIENDS
function addFriend(){
 db.ref("users").orderByChild("email").equalTo(friendEmail.value).once("value",s=>{
  s.forEach(u=>{
   db.ref("friends/"+auth.currentUser.uid+"/"+u.key).set(true);
   db.ref("friends/"+u.key+"/"+auth.currentUser.uid).set(true);
  });
 });
 friendEmail.value="";
}

function loadFriends(){
 friends.innerHTML="";
 db.ref("friends/"+auth.currentUser.uid).on("child_added",s=>{
  let uid=s.key;
  db.ref("users/"+uid).once("value",u=>{
   db.ref("online/"+uid).once("value",o=>{
    let div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`<b>${u.val().name}</b><br>
    ${o.exists()?'<span class="online">ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>':
    '<span class="offline">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: '+new Date(u.val().lastSeen).toLocaleTimeString()+'</span>'}`;
    div.onclick=()=>openPrivate(uid,u.val().name);
    friends.appendChild(div);
   });
  });
 });
}

// PRIVATE CHAT
function openPrivate(uid,name){
 currentChat=[auth.currentUser.uid,uid].sort().join("_");
 chatTitle.innerText=name;
 show("chat");
 messages.innerHTML="";
 db.ref("private/"+currentChat).off();
 db.ref("private/"+currentChat).on("child_added",s=>{
  let d=s.val();
  let div=document.createElement("div");
  div.className="msg "+(d.uid===auth.currentUser.uid?"me":"");
  div.innerText=d.text;
  messages.appendChild(div);
  if(d.uid!==auth.currentUser.uid) sound.play();
 });
}

function sendPrivate(){
 checkBan(()=>{
  db.ref("private/"+currentChat).push({
   uid:auth.currentUser.uid,text:msg.value,time:Date.now()
  });
  msg.value="";
 });
}

// PUBLIC CHAT
function loadPublic(){
 publicMsgs.innerHTML="";
 db.ref("public").limitToLast(50).on("child_added",s=>{
  let d=s.val();
  let div=document.createElement("div");
  div.className="msg";
  div.innerHTML=`<b>${d.name}</b>: ${d.text}`;
  if(auth.currentUser.email===ADMIN){
   div.innerHTML+=` <span class="admin" onclick="ban('${d.uid}')">[Ø­Ø¸Ø±]</span>`;
  }
  publicMsgs.appendChild(div);
  if(d.uid!==auth.currentUser.uid) sound.play();
 });
}

function sendPublic(){
 checkBan(()=>{
  db.ref("users/"+auth.currentUser.uid).once("value",u=>{
   db.ref("public").push({
    uid:auth.currentUser.uid,
    name:u.val().name,
    text:publicInput.value,
    time:Date.now()
   });
   publicInput.value="";
  });
 });
}

// BAN
function ban(uid){db.ref("bans/"+uid).set(Date.now());}
function checkBan(cb){
 db.ref("bans/"+auth.currentUser.uid).once("value",s=>{
  if(s.exists() && Date.now()-s.val()<BAN){
   alert("ğŸš« Ù…Ø­Ø¸ÙˆØ± 3 Ø³Ø§Ø¹Ø§Øª");
  }else{
   db.ref("bans/"+auth.currentUser.uid).remove();
   cb();
  }
 });
}

// UI
function nav(p){show(p)}
function show(p){
 auth.classList.add("hidden");
 home.classList.add("hidden");
 public.classList.add("hidden");
 chat.classList.add("hidden");
 profile.classList.add("hidden");
 document.getElementById(p).classList.remove("hidden");
}
function showAuth(){
 auth.classList.remove("hidden");
 home.classList.add("hidden");
 public.classList.add("hidden");
 chat.classList.add("hidden");
 profile.classList.add("hidden");
}
</script>

</body>
</html>
