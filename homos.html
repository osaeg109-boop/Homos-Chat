<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HIMOS Chat</title>

<!-- ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÖŸàŸÇÿπ -->
<link rel="icon" href="Logo.jpeg" type="image/jpeg">

<!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© (Open Graph) -->
<meta property="og:title" content="HIMOS Chat">
<meta property="og:description" content="ÿ£ŸÅÿ∂ŸÑ ÿ¥ÿßÿ™ ŸÑŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑÿ≠Ÿäÿ© ŸÖÿπ ÿßŸÑÿ¨ŸÖŸäÿπ.">
<meta property="og:image" content="Logo.jpeg">
<meta property="og:type" content="website">
<meta property="og:url" content="https://yourwebsite.com">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="HIMOS Chat">
<meta name="twitter:description" content="ÿ£ŸÅÿ∂ŸÑ ÿ¥ÿßÿ™ ŸÑŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑÿ≠Ÿäÿ© ŸÖÿπ ÿßŸÑÿ¨ŸÖŸäÿπ.">
<meta name="twitter:image" content="Logo.jpeg">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#121212;
  color:#fff;
}
.chat{
  max-width:500px;
  width:100%;
  height:100vh;
  margin:0 auto;
  background:#1e1e1e;
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 0 20px #000;
  display:flex;
  flex-direction:column;
}
.header{
  background:#00ff88;
  color:#000;
  padding:14px;
  font-weight:bold;
  text-align:center;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}
.header img{
  height:40px;
  margin-right:10px;
}
.header .online{
  font-size:12px;
  position:absolute;
  right:10px;
  top:14px;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#111;
}
.msg{
  display:flex;
  margin:8px 0;
  max-width:85%;
  position:relative;
}
.avatar{
  width:35px;
  height:35px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  margin-right:8px;
  flex-shrink:0;
}
.msg-content{
  background:#222;
  padding:8px 12px;
  border-radius:12px;
  flex:1;
  word-wrap:break-word;
  position:relative;
}
.msg.me .msg-content{background:#00ff88;color:#000;margin-left:auto;}
.msg .user-name{font-size:12px;font-weight:bold;margin-bottom:3px;}
.msg .time{font-size:10px;opacity:0.7;margin-top:2px;}
.reply-box{
  font-size:11px;
  border-left:3px solid #00ff88;
  padding:5px;
  margin-bottom:5px;
  color:#fff;
  background:#333;
  border-radius:5px;
}
.reply-btn{
  position:absolute;
  top:5px;
  right:5px;
  background:#00ff88;
  border:none;
  color:#000;
  font-size:10px;
  padding:2px 5px;
  cursor:pointer;
  border-radius:5px;
}
.footer{
  display:flex;
  flex-direction:column;
  border-top:1px solid #333;
}
#reply-display{
  font-size:11px;
  background:#333;
  padding:5px;
  border-left:3px solid #00ff88;
  color:#fff;
  display:none;
}
.footer input{
  flex:1;
  padding:14px;
  border:none;
  outline:none;
  width:100%;
  box-sizing:border-box;
}
.footer button{
  background:#00ff88;
  border:none;
  padding:14px;
  font-weight:bold;
  cursor:pointer;
  margin-top:5px;
}
.stats{
  font-size:12px;
  padding:6px;
  text-align:center;
  background:#000;
}
button.admin-btn{
  background:red;
  color:#fff;
  border:none;
  margin-left:5px;
  padding:2px 5px;
  font-size:10px;
  cursor:pointer;
  border-radius:5px;
}
@media(max-width:500px){
  .chat{border-radius:0;}
  .footer input{padding:10px;}
  .footer button{padding:10px;}
}
</style>
</head>

<body>

<div class="chat">
  <div class="header">
    <img src="Logo.jpeg" alt="HIMOS Chat Logo">
    üí¨ HIMOS Chat
    <span class="online">üü¢ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ: <span id="online">0</span></span>
  </div>

  <div id="stats" class="stats"></div>
  <div id="messages"></div>

  <div class="footer">
    <div id="reply-display"></div>
    <input id="msg" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ≠ÿ™ÿ±ŸÖÿ©...">
    <button onclick="send()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
  </div>
</div>

<audio id="notif-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// =================== CONFIG ===================
var firebaseConfig = {
  apiKey: "AIzaSyBEazcwOjQFvTTvKP7C-LltEOnIlkF54x0",
  authDomain: "chat-ab546.firebaseapp.com",
  databaseURL: "https://chat-ab546-default-rtdb.firebaseio.com",
  projectId: "chat-ab546",
  storageBucket: "chat-ab546.appspot.com",
  messagingSenderId: "1096336837314",
  appId: "1:1096336837314:web:2abe8434e5ced8ca1a895b"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const chatRef = db.ref("chat");
const statsRef = db.ref("stats");
const bansRef = db.ref("bans");
const onlineRef = db.ref("online");
const ADMIN = "Mohamed Homos";
const THREE_HOURS = 10800000; // 3 ÿ≥ÿßÿπÿßÿ™

// =================== USER ===================
let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ:");
  localStorage.setItem("chatName",username);
}

// =================== COLORS & AVATAR ===================
function color(name){
  let hash=0;
  for(let i=0;i<name.length;i++) hash=name.charCodeAt(i)+((hash<<5)-hash);
  return `hsl(${hash%360},70%,60%)`;
}
function avatarLetter(name){ return name.charAt(0).toUpperCase(); }
function timeAgo(t){
  let d=(Date.now()-t)/1000;
  if(d<60) return "ÿßŸÑÿ¢ŸÜ";
  if(d<3600) return `ŸÖŸÜÿ∞ ${Math.floor(d/60)} ÿØŸÇŸäŸÇÿ©`;
  return `ŸÖŸÜÿ∞ ${Math.floor(d/3600)} ÿ≥ÿßÿπÿ©`;
}

// =================== BANS ===================
bansRef.child(username).once("value",s=>{
  if(s.exists() && Date.now()-s.val()<THREE_HOURS){
    document.body.innerHTML="<h2 style='text-align:center;margin-top:100px'>üö´ ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÑŸÖÿØÿ© 3 ÿ≥ÿßÿπÿßÿ™</h2>";
    throw "BANNED";
  } else { bansRef.child(username).remove(); }
});

// =================== ONLINE ===================
let me = onlineRef.push(true);
me.onDisconnect().remove();
onlineRef.on("value",s=>{
  document.getElementById("online").innerText = s.numChildren();
});

// =================== STATS ===================
statsRef.child("messages").once("value",s=>{
  if(!s.exists()) statsRef.child("messages").set(0);
});
statsRef.child("users").once("value",s=>{
  if(!s.exists()) statsRef.child("users").set({});
});

// =================== SEND MESSAGE ===================
let replyTo = null;
function send(){
  let msgEl = document.getElementById("msg");
  let text = msgEl.value.trim();
  if(!text) return;

  chatRef.push({ user: username, text: text, time: Date.now(), reply: replyTo });
  msgEl.value = "";
  replyTo = null;
  document.getElementById("reply-display").style.display="none";
}

// =================== CHAT ===================
chatRef.limitToLast(200).on("child_added",snap=>{
  let d = snap.val();
  if(Date.now()-d.time>THREE_HOURS) { snap.ref.remove(); return; }

  let div = document.createElement("div");
  div.className = "msg "+(d.user===username?"me":"");

  let avatar = `<div class="avatar" style="background:${color(d.user)}">${avatarLetter(d.user)}</div>`;
  let replyBox = d.reply?`<div class="reply-box">‚Ü™ ${d.reply.user}: ${d.reply.text}</div>`:"";

  let adminButtons = "";
  if(username===ADMIN){
    adminButtons=` <button class="admin-btn" onclick="deleteMsg('${snap.key}')">ÿ≠ÿ∞ŸÅ</button>
                   <button class="admin-btn" onclick="banUser('${d.user}')">ÿ≠ÿ∏ÿ±</button>`;
  }

  div.innerHTML = avatar + `<div class="msg-content">
    ${replyBox}
    <div class="user-name">${d.user===ADMIN?'üëë ':' '}${d.user}${adminButtons}</div>
    <div>${d.text}</div>
    <div class="time">${timeAgo(d.time)}</div>
    <button class="reply-btn" onclick="setReply('${d.user}',\`${d.text}\`)">ÿ±ÿØ</button>
  </div>`;

  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;

  if(d.user!==username) document.getElementById("notif-sound").play();
});

// =================== SET REPLY ===================
function setReply(user,text){
  replyTo = {user,text};
  const display = document.getElementById("reply-display");
  display.innerText = `‚Ü™ ${user}: ${text}`;
  display.style.display="block";
  document.getElementById("msg").focus();
}

// =================== DELETE & BAN ===================
function deleteMsg(key){ chatRef.child(key).remove(); }
function banUser(user){ bansRef.child(user).set(Date.now()); }

// =================== TOP 3 USERS ===================
statsRef.child("users").on("value",s=>{
  if(username!==ADMIN) return;
  let users = s.val()||{};
  let arr = Object.keys(users).map(u=>({user:u,count:users[u]}));
  arr.sort((a,b)=>b.count-a.count);
  arr = arr.slice(0,3);
  document.getElementById("stats").innerHTML = "üìä ÿ£ŸÉÿ´ÿ± 3 ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÜÿ¥ÿ∑ŸäŸÜ: "+arr.map(a=>`${a.user} (${a.count})`).join(", ");
});

// =================== REGISTER SERVICE WORKER ===================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('firebase-messaging-sw.js')
  .then(registration => {
    console.log('Service Worker registered:', registration);
  }).catch(err => {
    console.error('Service Worker registration failed:', err);
  });
}
</script>

</body>
</html>
