<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HOMOS Chat</title>
<style>
*{box-sizing:border-box} body{margin:0;font-family:Arial,sans-serif;background:#0f0f0f;color:#fff;} 
.page{padding:15px;padding-bottom:90px} .hidden{display:none} 
h2,h3{text-align:center;margin:10px 0;} 
input,button{width:100%;padding:14px;margin:8px 0;border-radius:12px;border:none;font-size:16px;} 
input{background:#222;color:#fff} 
button{background:#00ff88;font-weight:bold;cursor:pointer;} 
button:active{opacity:.8} 
.friend,.msg{background:#1e1e1e;padding:12px;margin:6px 0;border-radius:12px;word-break:break-word;position:relative;} 
.me{background:#00ff88;color:#000} 
.online{color:#00ff88;font-size:13px} 
.offline{color:#aaa;font-size:13px} 
.nav{position:fixed;bottom:0;width:100%;height:70px;background:#000;display:flex;border-top:1px solid #222;} 
.nav div{flex:1;text-align:center;padding-top:10px;font-size:14px;color:#aaa;cursor:pointer;} 
.nav div.active{color:#00ff88} 
.nav div span{display:block;font-size:22px} 
.error{color:#ff5555;text-align:center;margin-top:10px;font-size:14px;} 
.avatar{width:30px;height:30px;border-radius:50%;display:inline-block;text-align:center;line-height:30px;margin-right:8px;font-weight:bold;color:#fff;}
.msg .replyBtn{position:absolute;right:5px;top:5px;font-size:12px;cursor:pointer;color:#00ff88;}
.msg .deleteBtn{position:absolute;left:5px;top:5px;font-size:12px;cursor:pointer;color:red;}
.onlineCount{color:#00ff88;font-size:14px;margin-bottom:10px;text-align:center;}
</style>
</head>
<body>

<!-- LOGIN BY NAME -->
<div id="auth" class="page">
  <h2>ğŸ” HOMOS Chat</h2>
  <input id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
  <div id="authError" class="error"></div>
</div>

<!-- HOME -->
<div id="home" class="page hidden">
  <h3>ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
  <div class="onlineCount">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: <span id="onlineCount">0</span></div>
  <input id="friendName" placeholder="Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù…">
  <button onclick="addFriend()">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
  <div id="friends"></div>
</div>

<!-- PUBLIC CHAT -->
<div id="public" class="page hidden">
  <h3>ğŸŒ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…</h3>
  <div id="publicMsgs"></div>
  <input id="publicInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©">
  <button onclick="sendPublic()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PRIVATE CHAT -->
<div id="chat" class="page hidden">
  <h3 id="chatTitle"></h3>
  <div id="messages"></div>
  <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
  <button onclick="sendPrivate()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<!-- PROFILE -->
<div id="profile" class="page hidden">
  <h3>ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h3>
  <p id="info"></p>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- NAV -->
<div class="nav">
  <div onclick="nav('home')"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
  <div onclick="nav('public')"><span>ğŸŒ</span>Ø§Ù„Ø¹Ø§Ù…</div>
  <div onclick="nav('profile')"><span>ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</div>
</div>

<audio id="sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase config
firebase.initializeApp({
 apiKey:"AIzaSyBEazcwOjQFvTTvKP7C-LltEOnIlkF54x0",
 authDomain:"chat-ab546.firebaseapp.com",
 databaseURL:"https://chat-ab546-default-rtdb.firebaseio.com",
 projectId:"chat-ab546"
});

const db=firebase.database();
const ADMIN="ahmedfouad01278837444@gmail.com"; // ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
const BAN=3*60*60*1000;
let currentUser=null;
let currentChat=null;
let replyTo=null;

// HELPER
function getColor(uid){return "#"+((Math.abs(hashCode(uid))%0xFFFFFF).toString(16).padStart(6,"0"));}
function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=str.charCodeAt(i)+((h<<5)-h);}return h;}

// LOGIN BY NAME
document.getElementById("loginBtn").addEventListener("click",function(){
 const name=document.getElementById("name").value.trim();
 if(!name){authError.innerText="âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"; return;}
 db.ref("users").orderByChild("name").equalTo(name).once("value",snapshot=>{
   if(snapshot.exists()){authError.innerText="âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„"; return;}
   // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
   let uid="uid_"+Date.now();
   currentUser={uid,name};
   db.ref("users/"+uid).set({name,lastSeen:Date.now()});
   db.ref("online/"+uid).set(true);
   db.ref("online/"+uid).onDisconnect().remove();
   show("home");
   info.innerText=name;
   updateOnlineCount();
   loadFriends();
   loadPublic();
 });
});

// FRIENDS
function addFriend(){
 const fn=document.getElementById("friendName").value.trim();
 if(!fn) return;
 db.ref("users").orderByChild("name").equalTo(fn).once("value",s=>{
   s.forEach(u=>{
     db.ref("friends/"+currentUser.uid+"/"+u.key).set(true);
     db.ref("friends/"+u.key+"/"+currentUser.uid).set(true);
   });
 });
 document.getElementById("friendName").value="";
}
function loadFriends(){
 friends.innerHTML="";
 db.ref("friends/"+currentUser.uid).on("child_added",s=>{
  const uid=s.key;
  db.ref("users/"+uid).once("value",u=>{
   db.ref("online/"+uid).once("value",o=>{
    const d=document.createElement("div");
    d.className="friend";
    const color=getColor(uid);
    const avatar=u.val().name[0].toUpperCase();
    d.innerHTML=`<span class="avatar" style="background:${color}">${avatar}</span><b>${u.val().name}</b><br>${o.exists()?'<span class="online">ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>':'<span class="offline">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± '+new Date(u.val().lastSeen).toLocaleTimeString()+'</span>'}`;
    d.onclick=()=>openPrivate(uid,u.val().name);
    friends.appendChild(d);
   });
  });
 });
}

// PRIVATE CHAT
function openPrivate(uid,name){
 currentChat=[currentUser.uid,uid].sort().join("_");
 chatTitle.innerText=name;
 show("chat");
 messages.innerHTML="";
 db.ref("private/"+currentChat).off();
 db.ref("private/"+currentChat).on("child_added",s=>{
  const d=s.val();
  const m=document.createElement("div");
  m.className="msg";
  if(d.uid===currentUser.uid) m.classList.add("me");
  m.innerHTML=`<span class="avatar" style="background:${getColor(d.uid)}">${d.text[0]}</span> ${d.text} <span class="replyBtn" onclick="setReply('${s.key}')">Ø±Ø¯</span>`;
  messages.appendChild(m);
  if(d.uid!==currentUser.uid) document.getElementById("sound").play();
 });
}
function sendPrivate(){
 if(!msg.value)return;
 let text=replyTo?`â†ª ${replyTo}: ${msg.value}`:msg.value;
 db.ref("private/"+currentChat).push({uid:currentUser.uid,text});
 msg.value=""; replyTo=null;
}

// PUBLIC CHAT
function loadPublic(){
 publicMsgs.innerHTML="";
 db.ref("public").limitToLast(50).on("child_added",s=>{
  const d=s.val();
  const m=document.createElement("div");
  m.className="msg";
  m.innerHTML=`<span class="avatar" style="background:${getColor(d.uid)}">${d.name[0]}</span> <b>${d.name}</b>: ${d.text} <span class="replyBtn" onclick="setReply('${d.name}')">Ø±Ø¯</span>`;
  publicMsgs.appendChild(m);
  if(d.uid!==currentUser.uid) document.getElementById("sound").play();
 });
}
function sendPublic(){
 if(!publicInput.value)return;
 db.ref("public").push({uid:currentUser.uid,name:currentUser.name,text:publicInput.value});
 publicInput.value="";
}

// REPLY
function setReply(name){replyTo=name; alert("Ø³ØªØ±Ø¯ Ø¹Ù„Ù‰: "+name);}

// LOGOUT
function logout(){
 db.ref("online/"+currentUser.uid).remove();
 currentUser=null;
 showAuth();
}

// NAV
function nav(p){show(p);}
function show(p){
 auth.classList.add("hidden");
 home.classList.add("hidden");
 public.classList.add("hidden");
 chat.classList.add("hidden");
 profile.classList.add("hidden");
 document.getElementById(p).classList.remove("hidden");
}
function showAuth(){auth.classList.remove("hidden");home.classList.add("hidden");public.classList.add("hidden");chat.classList.add("hidden");profile.classList.add("hidden");}

// ONLINE COUNT
function updateOnlineCount(){
 db.ref("online").on("value",s=>{onlineCount.innerText=s.numChildren();});
}
</script>
</body>
</html>
