<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HIMOS Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#121212;
  color:#fff;
}
.chat{
  max-width:500px;
  width:100%;
  height:100vh;
  margin:0 auto;
  background:#1e1e1e;
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 0 20px #000;
  display:flex;
  flex-direction:column;
}
.header{
  background:#00ff88;
  color:#000;
  padding:14px;
  font-weight:bold;
  text-align:center;
  position:relative;
}
.header .online{
  font-size:12px;
  position:absolute;
  right:10px;
  top:14px;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#111;
}
.msg{
  display:flex;
  margin:8px 0;
  max-width:85%;
  position:relative;
}
.avatar{
  width:35px;
  height:35px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  margin-right:8px;
  flex-shrink:0;
}
.msg-content{
  background:#222;
  padding:8px 12px;
  border-radius:12px;
  flex:1;
  word-wrap:break-word;
}
.msg.me .msg-content{background:#00ff88;color:#000;margin-left:auto;}
.msg .user-name{font-size:12px;font-weight:bold;margin-bottom:3px;}
.msg .time{font-size:10px;opacity:0.7;margin-top:2px;}
.reply-box{
  font-size:11px;
  border-left:3px solid #00ff88;
  padding-left:5px;
  margin-bottom:3px;
  color:#fff;
  background:#333;
  border-radius:5px;
}
.footer{
  display:flex;
  border-top:1px solid #333;
}
.footer input{
  flex:1;
  padding:14px;
  border:none;
  outline:none;
}
.footer button{
  background:#00ff88;
  border:none;
  padding:14px;
  font-weight:bold;
  cursor:pointer;
}
.stats{
  font-size:12px;
  padding:6px;
  text-align:center;
  background:#000;
}
button.admin-btn{
  background:red;
  color:#fff;
  border:none;
  margin-left:5px;
  padding:2px 5px;
  font-size:10px;
  cursor:pointer;
  border-radius:5px;
}
@media(max-width:500px){
  .chat{border-radius:0;}
  .footer input{padding:10px;}
  .footer button{padding:10px;}
}
</style>
</head>

<body>

<div class="chat">
  <div class="header">
    ğŸ’¬ HIMOS Chat
    <span class="online">ğŸŸ¢ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: <span id="online">0</span></span>
  </div>

  <div id="stats" class="stats"></div>
  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…Ø­ØªØ±Ù…Ø©...">
    <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<audio id="notif-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// =================== CONFIG ===================
var firebaseConfig = {
  apiKey: "AIzaSyBEazcwOjQFvTTvKP7C-LltEOnIlkF54x0",
  authDomain: "chat-ab546.firebaseapp.com",
  databaseURL: "https://chat-ab546-default-rtdb.firebaseio.com",
  projectId: "chat-ab546",
  storageBucket: "chat-ab546.appspot.com",
  messagingSenderId: "1096336837314",
  appId: "1:1096336837314:web:2abe8434e5ced8ca1a895b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const chatRef = db.ref("chat");
const usersRef = db.ref("users");
const bansRef = db.ref("bans");
const statsRef = db.ref("stats");
const onlineRef = db.ref("online");

const ADMIN = "Mohamed Homos";
const DAY = 10800000; // 3 Ø³Ø§Ø¹Ø§Øª Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©

// =================== USER ===================
let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ:");
  localStorage.setItem("chatName",username);
}

// Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
function color(name){
  let hash=0;
  for(let i=0;i<name.length;i++) hash=name.charCodeAt(i)+((hash<<5)-hash);
  return `hsl(${hash%360},70%,60%)`;
}

// =================== AVATAR ===================
function avatarLetter(name){
  return name.charAt(0).toUpperCase();
}

// =================== TIME ===================
function timeAgo(t){
  let d=(Date.now()-t)/1000;
  if(d<60) return "Ø§Ù„Ø¢Ù†";
  if(d<3600) return `Ù…Ù†Ø° ${Math.floor(d/60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
  return `Ù…Ù†Ø° ${Math.floor(d/3600)} Ø³Ø§Ø¹Ø©`;
}

// =================== BANS ===================
bansRef.child(username).once("value",s=>{
  if(s.exists() && Date.now()-s.val()<DAY){
    document.body.innerHTML="<h2 style='text-align:center;margin-top:100px'>ğŸš« ØªÙ… Ø­Ø¸Ø±Ùƒ Ù„Ù…Ø¯Ø© 3 Ø³Ø§Ø¹Ø§Øª</h2>";
    throw "BANNED";
  }else{
    bansRef.child(username).remove();
  }
});

// =================== ONLINE ===================
let me = onlineRef.push(true);
me.onDisconnect().remove();
onlineRef.on("value",s=>{
  document.getElementById("online").innerText = s.numChildren();
});

// =================== STATS ===================
statsRef.child("messages").once("value",s=>{
  if(!s.exists()) statsRef.child("messages").set(0);
});
statsRef.child("users").once("value",s=>{
  if(!s.exists()) statsRef.child("users").set({});
});

// =================== SEND ===================
let replyTo = null;
function send(){
  let msgEl = document.getElementById("msg");
  let text = msgEl.value.trim();
  if(!text) return;

  chatRef.push({
    user: username,
    text: text,
    time: Date.now(),
    reply: replyTo
  });
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  statsRef.child("messages").transaction(n=>(n||0)+1);
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  statsRef.child("users").child(username).transaction(n=>(n||0)+1);

  msgEl.value = "";
  replyTo = null;
}

// =================== CHAT ===================
chatRef.limitToLast(200).on("child_added",snap=>{
  let d = snap.val();
  if(Date.now()-d.time>DAY){
    snap.ref.remove();
    return;
  }

  let div = document.createElement("div");
  div.className = "msg "+(d.user===username?"me":"");
  
  // Avatar
  let avatar = `<div class="avatar" style="background:${color(d.user)}">${avatarLetter(d.user)}</div>`;
  
  // Reply box Ù…Ø¹ Ù„ÙˆÙ† Ù…Ù…ÙŠØ²
  let replyBox = "";
  if(d.reply){
    replyBox = `<div class="reply-box">
                  â†ª ${d.reply.user}: ${d.reply.text}
                </div>`;
  }
  
  // Admin buttons
  let adminButtons="";
  if(username===ADMIN){
    adminButtons=` <button class="admin-btn" onclick="deleteMsg('${snap.key}')">Ø­Ø°Ù</button>
                   <button class="admin-btn" onclick="banUser('${d.user}')">Ø­Ø¸Ø±</button>`;
  }

  div.innerHTML = avatar + `<div class="msg-content">
    ${replyBox}
    <div class="user-name">${d.user===ADMIN?'ğŸ‘‘ ':' '}${d.user}${adminButtons}</div>
    <div>${d.text}</div>
    <div class="time">${timeAgo(d.time)}</div>
  </div>`;

  // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯
  div.onclick = ()=>{
    if(d.user!==username) replyTo = {user:d.user,text:d.text};
    document.getElementById("msg").focus();
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØª
  if(d.user!==username) document.getElementById("notif-sound").play();
});

// =================== DELETE & BAN ===================
function deleteMsg(key){
  chatRef.child(key).remove();
}
function banUser(user){
  bansRef.child(user).set(Date.now());
}

// =================== TOP 3 USERS ===================
statsRef.child("users").on("value",s=>{
  if(username!==ADMIN) return;
  let users = s.val()||{};
  let arr = Object.keys(users).map(u=>({user:u,count:users[u]}));
  arr.sort((a,b)=>b.count-a.count);
  arr = arr.slice(0,3);
  stats.innerHTML = "ğŸ“Š Ø£ÙƒØ«Ø± 3 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†: "+arr.map(a=>`${a.user} (${a.count})`).join(", ");
});
</script>

</body>
</html>
